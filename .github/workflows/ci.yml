name: Extension CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

permissions:
    contents: read

jobs:
    validate:
        name: Validate & Lint
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'
                  cache-dependency-path: package-lock.json

            - name: Install dependencies
              run: npm install

            - name: Lint JavaScript
              run: npm run lint

            - name: Validate Schemas
              run: glib-compile-schemas --strict --dry-run extension/schemas/

            - name: Validate Metadata Template
              run: |
                  node -e "
                    const fs = require('fs');
                    const content = fs.readFileSync('extension/metadata.json', 'utf8');
                    const meta = JSON.parse(content);
                    const required = ['name', 'description', 'uuid', 'shell-version'];
                    for (const field of required) {
                      if (!meta[field]) {
                        console.error(\`Error: Missing required field '\${field}'\`);
                        process.exit(1);
                      }
                    }
                    console.log('Metadata template looks good! âœ…');
                  "

    package:
        name: Build Package
        runs-on: ubuntu-latest
        needs: validate
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'
                  cache-dependency-path: package-lock.json

            - name: Install dependencies
              run: npm install

            - name: Sync Version
              run: node .scripts/sync-version.js

            - name: Fetch GNOME Extensions Version
              run: node .scripts/fetch-ego-version.js

            - name: Lint JavaScript (for status)
              run: |
                  set -o pipefail
                  if npm run lint | tee .lint-output.txt; then
                    echo true > .lint-passed
                  else
                    echo false > .lint-passed
                    exit 1
                  fi

            - name: Update Lint Status
              run: npm run lint:status

            - name: Build Extension Package
              run: ./package.sh

            - name: Commit Changes
              run: |
                  git config --global user.name 'GitHub Action'
                  git config --global user.email 'action@github.com'
                  if [[ -n $(git status --porcelain) ]]; then
                    git add .
                    git commit -m "chore: Sync version, badges, and lint status [skip ci]"
                    git push
                  else
                    echo "No changes to commit"
                  fi

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: extension-package
                  path: brightness-restore@DarkPhilosophy.zip
