name: EGO Status Check

on:
    schedule:
        # Run once daily at 00:00
        - cron: '0 0 * * *'
    workflow_dispatch:

permissions:
    contents: write
    actions: write

jobs:
    check-status:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Fetch EGO Version & Update README
              run: node .scripts/fetch-ego-version.js

            - name: Commit Status Update
              run: |
                  git config --global user.name 'GitHub Action'
                  git config --global user.email 'action@github.com'

                  # Check if README changed
                  if [[ -n $(git status --porcelain .github/README.md) ]]; then
                      echo "Status changed. Committing..."
                      git add .github/README.md
                      git commit -m "chore: Update GNOME Extensions status [skip ci]"
                      git push
                  else
                      echo "No status change detected."
                  fi

            - name: Disable Workflow if Synced
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  # Check if we are now synced by grepping the README
                  if grep -q "Status-Synced-brightgreen" .github/README.md; then
                      echo "✅ Extension is synced! Disabling this workflow to stop checking."
                      gh workflow disable "EGO Status Check"
                  else
                      echo "⏳ Still pending. Will check again tomorrow."
                  fi
